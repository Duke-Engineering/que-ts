name: PR Summary

on:
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  pr-summary:
    runs-on: ubuntu-latest
    needs: []  # Will depend on other workflows completing

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Wait for other workflows
        uses: lewagon/wait-on-check-action@v1.3.1
        with:
          ref: ${{ github.event.pull_request.head.sha }}
          check-name: 'test'
          repo-token: ${{ secrets.GITHUB_TOKEN }}
          wait-interval: 10

      - name: Get workflow run results
        id: workflow-results
        uses: actions/github-script@v7
        with:
          script: |
            const { data: runs } = await github.rest.actions.listWorkflowRunsForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              head_sha: context.payload.pull_request.head.sha,
            });
            
            const testRun = runs.workflow_runs.find(run => run.name === 'Test');
            const securityRun = runs.workflow_runs.find(run => run.name === 'Security');
            
            const testStatus = testRun ? testRun.conclusion : 'pending';
            const securityStatus = securityRun ? securityRun.conclusion : 'pending';
            
            core.setOutput('test_status', testStatus);
            core.setOutput('security_status', securityStatus);

      - name: Find existing summary comment
        uses: peter-evans/find-comment@v2
        id: find-summary
        with:
          issue-number: ${{ github.event.pull_request.number }}
          comment-author: 'github-actions[bot]'
          body-includes: '## ğŸ¯ PR Summary Dashboard'

      - name: Create or update PR summary
        uses: peter-evans/create-or-update-comment@v3
        with:
          comment-id: ${{ steps.find-summary.outputs.comment-id }}
          issue-number: ${{ github.event.pull_request.number }}
          edit-mode: replace
          body: |
            ## ğŸ¯ PR Summary Dashboard
            
            ### ğŸ”„ CI/CD Status
            | Check | Status | Details |
            |-------|--------|---------|
            | **Tests** | ${{ steps.workflow-results.outputs.test_status == 'success' && 'âœ… Passed' || steps.workflow-results.outputs.test_status == 'failure' && 'âŒ Failed' || 'ğŸŸ¡ Running' }} | Node.js 18.x, 20.x, 22.x |
            | **Security** | ${{ steps.workflow-results.outputs.security_status == 'success' && 'âœ… Secure' || steps.workflow-results.outputs.security_status == 'failure' && 'âŒ Issues Found' || 'ğŸŸ¡ Scanning' }} | Dependencies & vulnerabilities |
            | **Build** | ${{ steps.workflow-results.outputs.test_status == 'success' && 'âœ… Built' || 'ğŸŸ¡ Pending' }} | TypeScript compilation |
            | **Package** | ${{ steps.workflow-results.outputs.test_status == 'success' && 'âœ… Ready' || 'ğŸŸ¡ Pending' }} | npm pack verification |
            
            ### ğŸ“Š Key Metrics
            - **Test Suites**: 3 (Client, Worker, Utils)
            - **Total Tests**: 16 
            - **Database**: PostgreSQL with advisory locks
            - **Node.js Versions**: 18.x, 20.x, 22.x tested
            
            ### ğŸš€ What's New in This PR
            - Review the changes in the "Files changed" tab
            - All tests must pass before merging
            - Security scan ensures dependency safety
            - Multi-version Node.js compatibility verified
            
            ### ğŸ“‹ Merge Checklist
            - [ ] All CI checks are passing âœ…
            - [ ] No security vulnerabilities detected ğŸ”’
            - [ ] Code review completed ğŸ‘€
            - [ ] Documentation updated (if needed) ğŸ“
            
            ### ğŸ”— Quick Links
            - [ğŸ§ª Test Details](https://github.com/${{ github.repository }}/actions/workflows/test.yml)
            - [ğŸ”’ Security Report](https://github.com/${{ github.repository }}/actions/workflows/security.yml)  
            - [ğŸ“Š Coverage Report](https://codecov.io/gh/${{ github.repository }})
            - [ğŸ³ Docker Setup](./DOCKER.md)
            
            ---
            *This summary is automatically updated when CI completes*
            
            <sub>Generated by [que-ts](https://github.com/${{ github.repository }}) CI/CD Pipeline</sub>